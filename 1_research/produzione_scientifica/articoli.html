<div id="orcidbox" style="max-width:980px;">
  <h2 style="margin:0 0 16px;">Articoli</h2>

  <div id="orcid_debug" style="padding:10px 12px;border:1px solid #ddd;background:#fafafa;border-radius:4px;font-size:14px;">
    Avvio…
  </div>

  <ol id="orcid_list" style="display:none; list-style:none; padding:0; margin:18px 0 0;"></ol>
</div>

<style>
  #orcid_list li{ display:flex; gap:14px; padding:14px 0; border-bottom:1px solid #e9e9e9; }
  .orcid_badge{
    width:34px; height:34px; border-radius:999px;
    display:flex; align-items:center; justify-content:center;
    font-weight:700; font-size:13px; background:#5b5b5b; color:#fff;
    flex:0 0 34px; margin-top:2px;
  }
  .orcid_title{ font-weight:700; line-height:1.3; margin:0 0 4px; }
  .orcid_meta{ font-size:13px; color:#666; line-height:1.4; }
  .orcid_links a{ font-size:13px; margin-right:10px; text-decoration:none; }
  .orcid_links a:hover{ text-decoration:underline; }
</style>

<script type="text/javascript">
(function(){
  // ===== CAMBIA QUESTO con l'ORCID reale =====
  var ORCID_ID = "0000-0003-1089-9809";
  // ==========================================

  var dbg  = document.getElementById("orcid_debug");
  var list = document.getElementById("orcid_list");

  function esc(s){
    return String(s || "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function setDbg(html){ dbg.innerHTML = html; }

  function xhrGet(url, cb){
    var x = new XMLHttpRequest();
    x.open("GET", url, true);
    x.onreadystatechange = function(){
      if (x.readyState === 4) cb(x.status, x.responseText);
    };
    x.send(null);
  }

  function allOriginsGetContents(targetUrl, cb){
    var proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(targetUrl);
    setDbg("Chiamo proxy…<br><small>" + esc(proxy) + "</small>");

    xhrGet(proxy, function(status, text){
      if (status !== 200) {
        cb(new Error("Proxy HTTP " + status));
        return;
      }
      var data;
      try { data = JSON.parse(text); } catch(e){
        cb(new Error("Risposta proxy non JSON"));
        return;
      }
      var contents = (data && data.contents) ? data.contents : "";
      cb(null, contents);
    });
  }

  function parseWorksXml(xmlText){
    var parser = new DOMParser();
    var doc = parser.parseFromString(xmlText, "text/xml");

    var pe = doc.getElementsByTagName("parsererror");
    if (pe && pe.length) throw new Error("XML non valido (parsererror).");

    var summaries = doc.getElementsByTagName("work-summary");
    var out = [];

    for (var s=0; s<summaries.length; s++){
      var node = summaries[s];

      // Titolo
      var title = "(Senza titolo)";
      var tnodes = node.getElementsByTagName("title");
      for (var k=0; k<tnodes.length; k++){
        var txt = (tnodes[k].textContent || "").replace(/\s+/g," ").trim();
        if (txt) { title = txt; break; }
      }

      // Anno
      var year = "";
      var ynodes = node.getElementsByTagName("year");
      if (ynodes && ynodes.length){
        year = (ynodes[0].textContent || "").trim();
      }

      // DOI
      var doi = "";
      var extIds = node.getElementsByTagName("external-id");
      for (var e2=0; e2<extIds.length; e2++){
        var typeN = extIds[e2].getElementsByTagName("external-id-type")[0];
        var valN  = extIds[e2].getElementsByTagName("external-id-value")[0];
        var type = typeN ? (typeN.textContent || "").trim().toLowerCase() : "";
        var val  = valN ? (valN.textContent || "").trim() : "";
        if (type === "doi" && val){
          doi = val;
          break;
        }
      }

      out.push({ title:title, year:year, doi:doi });
    }

    return out;
  }

  function render(items){
    if(!items || !items.length){
      setDbg("Nessuna pubblicazione trovata (o profilo ORCID senza works pubblici).");
      return;
    }

    items.sort(function(a,b){
      var ay = parseInt(a.year || "0", 10);
      var by = parseInt(b.year || "0", 10);
      return by - ay;
    });

    setDbg("OK ✅ Pubblicazioni trovate: " + items.length);
    list.style.display = "block";
    list.innerHTML = "";

    var total = items.length;
    for (var i=0; i<items.length; i++){
      var it = items[i];
      var num = total - i;

      var doiLink = it.doi
        ? ('<a href="https://doi.org/'+esc(it.doi)+'" target="_blank" rel="noopener">DOI</a>')
        : "";

      var li = document.createElement("li");
      li.innerHTML =
        '<div class="orcid_badge">'+ num +'</div>' +
        '<div>' +
          '<div class="orcid_title">'+ esc(it.title) +'</div>' +
          '<div class="orcid_meta">'+ (it.year ? esc(it.year) : "") +'</div>' +
          '<div class="orcid_links">'+ doiLink +'</div>' +
        '</div>';

      list.appendChild(li);
    }
  }

  // MAIN
  try {
    var worksUrl = "https://pub.orcid.org/v3.0/" + ORCID_ID + "/works";
    setDbg("Avvio…<br><small>Target: " + esc(worksUrl) + "</small>");

    allOriginsGetContents(worksUrl, function(err, contents){
      if (err){
        setDbg("❌ Errore: " + esc(err.message));
        return;
      }
      if(!contents || !contents.trim()){
        setDbg("❌ Risposta vuota dal proxy (contents vuoto).");
        return;
      }

      setDbg("Ricevuti dati: " + contents.length + " caratteri. Parsing…");
      try {
        var items = parseWorksXml(contents);
        render(items);
      } catch(parseErr){
        setDbg("❌ Errore parsing: " + esc(parseErr.message));
      }
    });

  } catch(ex){
    setDbg("❌ Errore JS: " + esc(ex.message));
  }

})();
</script>
